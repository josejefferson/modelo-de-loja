<%
const _disStk = !product.stock ? 'disabled' : ''
const _usRow = users.length !== 0 ? 'row' : ''
%>

<div class="container my-4">
	<h1 class="mb-4"><i class="fas fa-dollar-sign"></i> Comprar</h1>

	<form action="/buy/<%= product.id %>" method="POST" name="buy">
		<div class="row">
			<%- include('../partials/_product.ejs', {product, env: 'buy'}) %>

			<div class="<%=_usRow%> col col-12 col-md-8 col-lg-9">
				<h3>Comprar como:
					<a href="/users" class="btn btn-light btn-sm">
						<i class="fas fa-users"></i> Gerenciar usuários
					</a>
				</h3>

				<% users.forEach((user, i) => { %>
					<%- include('../partials/_user.ejs', {user, i, env: 'buy'}) %>
				<% }) %>
				<% if (users.length === 0) { %>
					<div class="col-12 col-md-6 mt-4">
						<div class="card shadow-sm h-100 bg-light">
							<a href="/users/add" class="btn card-body d-flex flex-column align-items-center justify-content-center">
								<i class="fas fa-plus fa-5x"></i>
								<b class="mt-3 fs-5">Adicionar usuário</b>
							</a>
						</div>
					</div>
				<% } %>

				<label class="form-group d-block mt-3">
					<div>Observações:</div>
					<textarea class="form-control" name="other" placeholder="Mais alguma informação?"><%= locals.other %></textarea>
				</label>

				<div class="text-center mt-3">
					<button class="btn btn-lg btn-success mx-auto" type="submit" <%=_disStk%>>
						<i class="fas fa-dollar-sign"></i> Finalizar compra
					</button>
				</div>
			</div>
		</div>
	</form>
</div>

<script src="/js/angular.min.js"></script>
<script>
	document.buy.onsubmit = function (e) {
		e.preventDefault()
		Swal.fire({
			title: 'Finalizar compra',
			text: 'Tem certeza que deseja finalizar esta compra?', //todo: mostrar resumo
			showDenyButton: true,
			showCancelButton: false,
			confirmButtonText: 'Sim',
			denyButtonText: 'Não'
		}).then(r => {
			if (!r.isConfirmed) return
			this.submit()
		})
	}

	angular.module('store', []).controller('storeCtrl', ['$scope', ($scope) => {
		$scope.products = {}
		$scope.inc = (e, max) => $scope.products[e] = (++$scope.products[e] > max) ? max : $scope.products[e]
		$scope.dec = e => $scope.products[e] = --$scope.products[e] || 1
	}])
</script>