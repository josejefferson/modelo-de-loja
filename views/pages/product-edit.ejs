<div style="position: fixed;right: 0;top: 0;z-index:1034;color:white;background-color: rgba(0,0,0,0.5);font-size:24px;pointer-events:none">
	<span class="d-sm-none">XS</span>
	<span class="d-none d-sm-block d-md-none">SM</span>
	<span class="d-none d-md-block d-lg-none">MD</span>
	<span class="d-none d-lg-block d-xl-none">LG</span>
	<span class="d-none d-xl-block d-xxl-none">XL</span>
	<span class="d-none d-xxl-block">XXL</span>
</div>


<!-- <ng-include src="'/templates/select-media.html'"></ng-include> -->


<%
const _redir = query.r ? `?r=${encodeURIComponent(query.r)}` : ''
const action = (locals.product ? `/products/edit/${product.id}` : '/products/add') + _redir
%>

<div class="container my-4" ng-controller="productsEditCtrl">
	<% if (!locals.product) { %>
		<h1 class="mb-4"><i class="fas fa-plus"></i> Adicionar produto</h1>
	<% } else { %>
		<h1 class="mb-4"><i class="fas fa-pencil-alt"></i> Editar produto</h1>
	<% } %>

	<form action="<%= action %>" method="POST" class="row">
		<div class="col-12 col-md-9">
			<label class="form-group d-block">
				<div><i class="fas fa-file-signature"></i> Nome <span class="text-danger">*</span></div>
				<input type="text" class="form-control form-control-lg" name="name" autocomplete="off"
					ng-model="product.name" autofocus required>
			</label>

			<label class="form-group d-block">
				<div class="mt-2"><i class="fas fa-align-left"></i> Descrição</div>
				<textarea class="form-control" rows="4" name="description" autocomplete="off"
					ng-model="product.description"></textarea>
			</label>

			<div class="row">
				<label class="col-6 col-lg-3 form-group d-block">
					<div class="mt-2"><i class="fas fa-dollar-sign"></i> Preço <span class="text-danger">*</span></div>
					<div class="input-group">
						<div class="input-group-text">R$</div>
						<input type="number" step=".01" class="form-control" name="price" autocomplete="off"
							ng-model="product.price" required>
					</div>
				</label>

				<label class="col-6 col-lg-3 form-group d-block">
					<div class="mt-2"><i class="fas fa-dollar-sign"></i> Preço antigo</div>
					<div class="input-group">
						<div class="input-group-text">R$</div>
						<input type="number" step=".01" class="form-control" name="oldprice" autocomplete="off" ng-model="product.oldprice">
					</div>
				</label>

				<label class="col-6 col-lg-3 form-group d-block">
					<div class="mt-2"><i class="fas fa-tag"></i> Selo</div>
					<input type="text" class="form-control" name="badge" autocomplete="off"
						ng-model="product.badge">
				</label>

				<label class="col-6 col-lg-3 form-group d-block">
					<div class="mt-2"><i class="fas fa-archive"></i> Estoque <span class="text-danger">*</span></div>
					<div class="input-group">
						<input type="number" class="form-control" name="stock" autocomplete="off" ng-model="product.stock" required>
						<div class="input-group-text">un.</div>
					</div>
				</label>
			</div>

			<label class="form-group d-block">
				<div class="mt-2"><i class="fas fa-image"></i> URL da imagem</div>
				<input type="text" class="form-control" name="image" autocomplete="off" ng-model="product.image"> <!--temp type text-->
			</label>


			<div>
				<div class="mt-2"><i class="fas fa-photo-video"></i> Imagens/vídeos</div>
				<div class="row">
					<div class="col-6 col-sm-4 col-lg-3 col-xxl-2" ng-repeat="m in product.media" ng-switch="m.type">
						<div class="card overflow-hidden" ng-switch-when="image">
							<input type="hidden" name="media[{{::$index}}][type]" value="image">
							<input type="hidden" name="media[{{::$index}}][url]" value="{{::m.url}}">
							<div class="ratio ratio-16x9 overflow-hidden">
								<img ng-src="{{::m.url}}" class="card-img-top" style="object-fit: cover;">
							</div>

							<div class="row m-0">
								<button type="button" class="col-auto btn btn-light btn-sm rounded-0" ng-click="::move(product.media, $index, $index - 1)" ng-disabled="$index === 0">
									<i class="mdi mdi-arrow-left"></i>
								</button>
								<button type="button" class="col btn btn-light btn-sm rounded-0" ng-click="::remove(m, product.media)">
									<i class="mdi mdi-delete"></i>
								</button>
								<button type="button" class="col-auto btn btn-light btn-sm rounded-0" ng-click="::move(product.media, $index, $index + 1)" ng-disabled="$index === product.media.length - 1">
									<i class="mdi mdi-arrow-right"></i>
								</button>
							</div>
						</div>

						<div ng-switch-when="yt-video">
							O sistema não está preparado para mostrar vídeos do YouTube
						</div>
					</div>
				</div>
				<button type="button" class="btn btn-light shadow-sm border h-100" ng-click="selectImageModal()"><i
						class="fas fa-image"></i> Adicionar imagem</button>
				<button type="button" class="btn btn-light shadow-sm border h-100" ng-click="selectImageURLModal()"><i
						class="fas fa-image"></i> Adicionar imagem (URL)</button>
				<button type="button" class="btn btn-light shadow-sm border h-100" ng-click="uploadModal()"><i
					class="fas fa-upload"></i> Enviar imagem</button>
					<button type="button" class="btn btn-light shadow-sm border h-100" ng-click="selectYouTubeModal()"><i
						class="fab fa-youtube"></i> Adicionar vídeo do YouTube</button>
			</div>
			
			<label class="form-check form-switch mt-2">
				<input class="form-check-input" type="checkbox" name="hidden" value="true" ng-model="product.hidden">
				<div class="form-check-label">
					<i class="fas fa-eye-slash"></i> Oculto
				</div>
			</label>
		</div>
		
		<!-- Pré-visualização do card do produto -->
		<div class="store-product d-none d-md-block col-3 px-1 py-1">
			<h4 class="text-muted mb-3">
				<span class="text-truncate">Pré-visualização</span>
			</h4>
			<div class="card shadow text-decoration-none text-dark">
				<div class="position-absolute top-0 end-0 bg-danger text-white p-1 prodBadge" ng-if="product.badge"
				ng-bind="product.badge"></div>
				
				<div class="ratio ratio-16x9 overflow-hidden" ng-if="product.image">
					<img ng-src="{{product.image}}" class="store-product-image card-img-top" style="object-fit:cover">
				</div>
				
				<div class="ratio ratio-16x9 bg-light" ng-if="!product.image">
					<div class="d-flex align-items-center justify-content-center text-secondary">
						<i class="fas fa-5x fa-shopping-basket"></i>
					</div>
				</div>
				
				<div class="card-body d-flex flex-column">
					<h5 class="card-title">
						<i class="fas fa-eye-slash" ng-if="product.hidden"></i>
						{{product.name}}
					</h5>
					<div class="card-text">
						<div>
							<i class="fas fa-xs fa-star w-auto text-warning"></i>
							<i class="fas fa-xs fa-star w-auto text-warning"></i>
							<i class="fas fa-xs fa-star w-auto text-warning"></i>
							<i class="far fa-xs fa-star w-auto text-warning"></i>
							<i class="far fa-xs fa-star w-auto text-warning"></i>
							<small><small class="fs-8">3 (45)</small></small>
						</div>
						<div class="mt-2">
							<s class="d-block fs-6 text-secondary" ng-if="product.oldprice">
								<small>R$ {{product.oldprice.toFixed(2).toString().replace('.', ',')}}</small>
							</s>
							<div ng-if="product.price">
								<b class="fs-5">R$ {{product.price.toFixed(2).toString().replace('.', ',')}}</b>
							</div>
							<small>
								<span ng-if="product.stock > 0">({{product.stock}} unid. dispon.)</span>
								<span ng-if="product.stock === -1">(disponível)</span>
								<span ng-if="product.stock === 0" class="text-danger">(esgotado)</span>
							</small>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="text-center mt-3">
			<button class="btn btn-lg btn-success" type="submit">
				<i class="fas fa-save"></i> Salvar produto
			</button>
		</div>
	</form>
</>

<%- contentFor('script') %>
<script>const serverData = <%- JSON.stringify(locals.product || locals.userData?.[0] || null) %></script>
<script src="/js/admin/productsEdit.js"></script>
<script src="/js/admin/selectImage.js"></script>
<script src="/js/admin/upload.js"></script>
<script src="/js/admin/selectYouTube.js"></script>