<%
product.priceStr = product.price?.toFixed(2).toString().replace('.', ',')
product.oldpriceStr = product.oldprice?.toFixed(2).toString().replace('.', ',')
product.description = product.description?.replace(/\n/g, '<br>')
const {_1, _2, _3, _4, _5} = product.rating
product.ratingUsers = _1 + _2 + _3 + _4 + _5
product.ratingNum = Math.round((_1 * 1 + _2 * 2 + _3 * 3 + _4 * 4 + _5 * 5) / product.ratingUsers) || 0
const _disStk = !product.stock ? 'disabled' : ''
const _cartHid = cart.includes(product.id) ? 'hidden' : ''
const _$cartHid = !cart.includes(product.id) ? 'hidden' : ''
const _stkQtd = product.stock > 0 ? `(${product.stock} em estoque)` : ''
%>

<div class="container my-4">
	<% if (product.image) { %>
		<img src="<%= product.image %>" class="mt-3 w-100">
	<% } %>

	<h1 class="my-2"><%= product.name %></h1>
	<p>
		<i class="fa<%=product.ratingNum>=1?'s':'r'%> fa-xs fa-star w-auto text-warning"></i>
		<i class="fa<%=product.ratingNum>=2?'s':'r'%> fa-xs fa-star w-auto text-warning"></i>
		<i class="fa<%=product.ratingNum>=3?'s':'r'%> fa-xs fa-star w-auto text-warning"></i>
		<i class="fa<%=product.ratingNum>=4?'s':'r'%> fa-xs fa-star w-auto text-warning"></i>
		<i class="fa<%=product.ratingNum>=5?'s':'r'%> fa-xs fa-star w-auto text-warning"></i>
		<small><small class="fs-8"><%= product.ratingNum %> (<%= product.ratingUsers %> avaliações)</small></small>
	</p>

	<p class="fs-4">
		<% if (product.oldpriceStr) { %>
			<s class="d-block fs-6 text-secondary">
				<small>R$ <%= product.oldpriceStr %></small>
			</s>
		<% } %>
		<b>R$ <%= product.priceStr %></b>
		<% if (!product.stock) { %>
			<span class="text-danger fs-4">(esgotado)</span>
		<% } %>
	</p>

	<div class="row mb-3">
		<div class="col-12 col-md-6">
			<a href="/buy/<%= product.id %>" class="btn btn-lg btn-warning w-100 <%=_disStk%>">
				<i class="fas fa-dollar-sign"></i> Comprar <%=_stkQtd%>
			</a>
		</div>
		<div class="col-12 col-md-6">
			<button data-product="<%= product.id %>"
				class="btn btn-lg btn-primary w-100 mt-1 mt-md-0 addToCart <%=_cartHid%> <%=_disStk%>">
				<i class="fas fa-cart-plus"></i> Carrinho
			</button>
			<button data-product="<%= product.id %>"
				class="btn btn-lg btn-danger w-100 mt-1 mt-md-0 removeFromCart <%=_$cartHid%>">
				<i class="fas fa-cart-arrow-down"></i> Carrinho
			</button>
		</div>
	</div>

	<p><%- product.description %></p>
</div>

<script>
	$('.addToCart').click(function () {
		const productID = $(this).data('product')
		cart({ add: productID })
		toast('O item foi adicionado ao carrinho')
		$(this).toggleClass('hidden')
		$(this).next().toggleClass('hidden')
	})

	$('.removeFromCart').click(function () {
		const productID = $(this).data('product')
		cart({ remove: productID })
		toast('O item foi removido do carrinho')
		$(this).toggleClass('hidden')
		$(this).prev().toggleClass('hidden')
	})
</script>