<%
const _redir = query.r ? `?r=${encodeURIComponent(query.r)}` : ''
const action = (locals.product ? `/products/edit/${product.id}` : '/products/add') + _redir
const { id, name, description, price, oldprice, image, stock } = locals.product || locals.userData?.[0] || {}
%>

<div class="container my-4" ng-controller="productsEditCtrl">
	<% if (!locals.product) { %>
		<h1 class="mb-4"><i class="fas fa-plus"></i> Adicionar produto</h1>
	<% } else { %>
		<h1 class="mb-4"><i class="fas fa-pencil-alt"></i> Editar produto</h1>
	<% } %>

	<form action="<%= action %>" method="POST">
		<label class="form-group d-block">
			<div>Nome <span class="text-danger">*</span></div>
			<input type="text" class="form-control form-control-lg" name="name" value="<%= name %>" autocomplete="off" autofocus required>
		</label>

		<label class="form-group d-block">
			<div class="mt-2">Descrição</div>
			<textarea class="form-control" rows="4" name="description" autocomplete="off"><%= description %></textarea>
		</label>

		<label class="form-group d-block">
			<div class="mt-2">Preço <span class="text-danger">*</span></div>
			<div class="input-group">
				<div class="input-group-text">R$</div>
				<input type="number" step=".01" class="form-control form-control-lg" name="price" value="<%= price %>" autocomplete="off" required>
			</div>
		</label>

		<label class="form-group d-block">
			<div class="mt-2">Preço antigo</div>
			<div class="input-group">
				<div class="input-group-text">R$</div>
				<input type="number" step=".01" class="form-control form-control-lg" name="oldprice" value="<%= oldprice %>" autocomplete="off">
			</div>
		</label>

		<label class="form-group d-block">
			<div class="mt-2">URL da imagem</div> <!--colocar ícones nos labels e talvez aumentar-->
			<input type="url" class="form-control" name="image" value="<%= image %>" autocomplete="off">
		</label>

		<div>
			<div class="mt-2">Imagens/vídeos</div>
			<button type="button" class="btn btn-light shadow-sm border h-100" ng-click="loadController()"><i class="fas fa-plus"></i> Adicionar</button>
		</div>

		<label class="form-group d-block">
			<div class="mt-2">Estoque <span class="text-danger">*</span></div>
			<input type="number" class="form-control" name="stock" value="<%= stock %>" autocomplete="off" required>
		</label>

		<div class="text-center mt-3">
			<button class="btn btn-lg btn-success" type="submit">
				<i class="fas fa-save"></i> Salvar produto
			</button>
		</div>
	</form>
</div>

<script>
	///////////////////// TEST /////////////////////
	angular.module('store', []).controller('productsEditCtrl', ['$scope', '$compile', ($scope, $compile)=>{
		$scope.test = 'Hello World'
		$scope.loadController = () => {
			html = $compile(`
				<label class="dropArea" ng-class="upload.state" ng-on-dragenter="upload.event($event).dragenter($event)"
					ng-on-dragover="upload.event($event).dragover($event)" ng-on-dragleave="upload.event($event).dragleave($event)"
					ng-on-drop="upload.event($event).drop($event)" ng-controller="fileUploadCtrl">

					<input type="file" name="file" ng-on-change="upload.change($event)" class="hidden" multiple>
					<h2 class="dropTitle" ng-switch on="upload.state">
						<span ng-switch-default>Arraste os arquivos ou clique aqui</span>
						<span ng-switch-when="highlight">Solte para enviar</span>
						<span ng-switch-when="uploading">Enviando</span>
					</h2>
					<div class="dropText">Aceitamos os formatos JPG, PNG, WEBP, SVG</div>
					<small class="uploadSuccess text-success">Arquivos enviados com sucesso</small>
					<small class="uploadError text-danger">Ocorreu um erro ao enviar os arquivos</small>

					<div class="progress w-50">
						<div class="progress-bar progress-bar-striped progress-bar-animated bg-secondary w-100"></div>
					</div>
				</label>
			`)($scope),
			Swal.fire({
				width: '100%',
				padding: '20px 0',
				margin: 0,
				// height: '100%', ????
				willOpen: popup => {
					angular.element(popup.querySelector('.swal2-content')).append(html)
				}
			})
		}
	}])

	angular.module('store').controller('fileUploadCtrl', ['$scope', ($scope) => {
		$scope.upload = {
			state: '',
			error: null,
			change: (e) => {
				$scope.upload.upload([...e.target.files])
				e.target.value = ''
			},
			event: (e) => {
				e.preventDefault()
				e.stopPropagation()
				return {
					dragenter: (e) => { $scope.upload.state = 'highlight' },
					dragover: (e) => { $scope.upload.state = 'highlight' },
					dragleave: (e) => { $scope.upload.state = '' },
					drop: (e) => {
						$scope.upload.state = '';
						$scope.upload.upload([...e.dataTransfer.files])
					}
				}
			},
			upload: (files) => {
				const form = new FormData()
				files.forEach(file => form.append('files', file))
				$scope.upload.state = 'uploading'
				fetch('/images/upload', {
					method: 'POST',
					body: form
				}).then(r => { if (!r.ok) throw r; return r.json() })
					.then(() => {
						$scope.upload.state = 'success'
						$scope.$apply()
					}).catch(() => {
						$scope.upload.state = 'error'
						$scope.$apply()
					})
			}
		}
	}])
</script>