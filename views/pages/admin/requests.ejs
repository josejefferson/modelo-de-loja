<%

requests = requests.reduce(function (r, b) {
	r[b.name] = r[b.name] || [];
	r[b.name].push(b);
	return r;
}, Object.create(null))

%>

<div class="container my-4">
	<h1>Pedidos</h1>

	<% for (request in requests) { %>
	<div class="card mt-4">
		<div class="card-body">
			<h4><%= request %></h4>
			<div><b>Endereço:</b> <%= requests[request][0].address %></div>
			<div><b>Telefone:</b> <a href><%= requests[request][0].phone %></a></div> <!-- >> verificar se foi inserido um telefone -->
			<div><b>E-mail:</b> <a href="mailto:<%= requests[request][0].email %>"><%= requests[request][0].email %></a></div>

			<%
			let sum = 0
			requests[request].reverse().forEach(r => sum += parseFloat(r.produto.price))
			sum = sum.toLocaleString(undefined , {
				minimumFractionDigits: 2
			})
			%>

			<div><b>Total:</b> R$ <%= sum.replace('.', ',') %></div>

			<div class="requests">

				<% requests[request].reverse().forEach(request => { %>

				<div class="card mt-3">
					<div class="row m-0">
						<div class="col col-12 col-md-2 p-2 rounded">
							<img src="<%= request.produto.image %>" class="rounded w-100">
						</div>
						<div class="col col-12 col-md-7 col-lg-8 py-3">
							<h5><%= '1' %> &times; <%= request.produto.name %></h5>

							<h6 class="text-muted"><%= '1' %> &times; R$ <%= request.produto.price.replace('.', ',') %> = <b>R$
									<%= request.produto.price.replace('.', ',') %></b></h6>

							<% if (request.other) { %><div><b>Mais informações:</b>
								<div><%- request.other.replace(/\n/g, '<br>') %></div>
							</div><% } %>

							<div><b>Data/hora:</b> <%= moment(request.createdAt).format('DD/MM/YYYY - h:mm A') %></div>
						</div>
						<div class="col col-12 col-md-3 col-lg-2 p-3">
							<button class="btn btn-sm btn-success act w-100" data-action="confirm"
								data-request-id="<%= request.id %>">Confirmar</button>
							<button class="btn btn-sm btn-danger act w-100" data-action="reject"
								data-request-id="<%= request.id %>">Rejeitar</button>
							<button class="btn btn-sm btn-warning act w-100" data-action="confirm"
								data-request-id="<%= request.id %>">Pronto</button>
						</div>
					</div>
				</div>
				<% }) %>
			</div>
		</div>
	</div>
	<% } %>

</div>

<!-- <pre>
	<%= JSON.stringify(requests, null, '\t') %>
</pre> -->

<script>
	$('.act').click(function () {
		const $this = $(this)
		const id = $this.data('request-id')
		const confirm = $this.data('action') == 'confirm'

		$.ajax({
			method: 'POST',
			url: '/admin/requests/confirm',
			data: { id, confirm },
			beforeSend: () => $this.parent().find('.act').prop('disabled', true),
			success: res => {
				if (res.success) $this.closest('.card').slideUp(/* >> definir tempo*/, function () { this.remove() })
				$this.parent().find('.act').prop('disabled', false)
			}
		})
	})
</script>